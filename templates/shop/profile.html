{% extends 'shop/base.html' %}
{% block title %}My Profile{% endblock %}

{% block content %}

<!-- ================= POPUP MESSAGES ================= -->
{% if messages %}
<div class="popup-container">
  {% for message in messages %}
    <div class="popup-message">
      {{ message }}
    </div>
  {% endfor %}
</div>
{% endif %}

<div class="center-wrapper">
  <div class="profile-widget">

    <h2 class="profile-header">My Profile</h2>

    <!-- üî• SINGLE FORM ONLY -->
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- ================= PROFILE PHOTO ================= -->
      <div class="profile-photo-box">

        <img id="profilePreview"
             src="{% if profile.profile_image %}{{ profile.profile_image.url }}{% else %}https://via.placeholder.com/110{% endif %}"
             class="profile-photo">

        <!-- üî• REAL FILE INPUT (HIDDEN) -->
        {{ profile_form.profile_image }}

        <button type="button" class="choose-btn" id="uploadBtn">
          Change Photo
        </button>

        {% if profile.profile_image %}
          <button type="submit"
                  name="delete_image"
                  value="1"
                  class="delete-btn"
                  style="margin-top:6px;">
            Delete Photo
          </button>
        {% endif %}

      </div>

      <!-- ================= FORM FIELDS ================= -->
      <div class="widget-grid">

        <div class="widget-group">
          <label>Username</label>
          {{ user_form.username }}
        </div>

        <div class="widget-group">
          <label>Email</label>
          {{ user_form.email }}
        </div>

        <div class="widget-group">
          <label>Phone</label>
          {{ profile_form.phone }}
        </div>

        <div class="widget-group full-row">
          <label>Address</label>
          {{ profile_form.address }}
        </div>

      </div>

      <div class="widget-actions">
        <button type="submit" class="btn widget-save">Save Changes</button>
        <a href="{% url 'my_profile' %}" class="btn widget-back">‚Üê Back</a>
      </div>

    </form>

  </div>
</div>

<!-- ================= STYLES ================= -->
<style>
.center-wrapper {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:90vh;
}

.profile-widget {
  background:#fff;
  width:430px;
  padding:40px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}

.profile-header {
  text-align:center;
  font-size:26px;
  margin-bottom:25px;
}

/* PROFILE PHOTO */
.profile-photo-box {
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-bottom:25px;
}

.profile-photo {
  width:110px;
  height:110px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #1ec38b;
  margin-bottom:10px;
}

/* hide real file input */
#id_profile_image {
  display:none;
}

.choose-btn {
  background:#007bff;
  color:#fff;
  border:none;
  padding:6px 14px;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
}

.delete-btn {
  background:#dc3545;
  color:#fff;
  border:none;
  padding:5px 12px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}

/* FORM */
.widget-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}

.full-row { grid-column:span 2; }

.widget-group label {
  font-weight:600;
  margin-bottom:5px;
  display:block;
}

.widget-group input,
.widget-group textarea {
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

.widget-actions {
  display:flex;
  gap:12px;
  margin-top:30px;
}

.btn {
  flex:1;
  padding:10px;
  border-radius:8px;
  font-weight:600;
  border:none;
  cursor:pointer;
  text-decoration:none;
}

.widget-save { background:#1ec38b; color:#fff; }
.widget-back { background:#eee; color:#000; }

/* ================= POPUP ================= */
.popup-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}

.popup-message {
  background: #1ec38b;
  color: #fff;
  padding: 12px 18px;
  border-radius: 8px;
  margin-bottom: 10px;
  font-weight: 600;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  animation: slideIn 0.4s ease, fadeOut 0.4s ease 3s forwards;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
  to { opacity: 0; transform: translateX(100%); }
}
</style>

<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fileInput = document.getElementById('id_profile_image');
  const uploadBtn = document.getElementById('uploadBtn');
  const preview = document.getElementById('profilePreview');

  uploadBtn.addEventListener('click', function () {
    fileInput.click();
  });

  fileInput.addEventListener('change', function () {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  });
});
</script>

{% endblock %}
